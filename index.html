<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Følgeseddel - Felson Watersafe ApS</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        :root {
            --brand: #00B0F0;
            --text: #1a1a1a;
            --text-light: #6b7280;
            --border: #e5e7eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #00B0F0 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .security-badge {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 1000;
        }

        .app-container {
            width: 100%;
            max-width: 920px;
            margin: 0 auto;
        }

        .document-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            margin-bottom: 2rem;
        }

        .card-header {
            padding: 2.5rem 3rem 2rem;
            background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
            border-bottom: 2px solid var(--brand);
            text-align: right;
        }

        .logo {
            color: var(--brand);
            font-size: 2rem;
            font-weight: 800;
        }

        .card-content {
            padding: 3rem;
        }

        .main-title {
            text-align: center;
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 2.5rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 2rem;
            margin-bottom: 2.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            font-size: 0.8125rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            font-size: 0.9375rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--brand);
            box-shadow: 0 0 0 4px rgba(0, 176, 240, 0.08);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-top: 1.5rem;
        }

        .data-table thead {
            background: linear-gradient(135deg, var(--brand) 0%, #0090cc 100%);
        }

        .data-table th {
            padding: 1rem;
            text-align: left;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
        }

        .data-table th.col-antal {
            width: 20%;
            text-align: center;
        }

        .data-table tbody tr {
            background: white;
        }

        .data-table tbody tr:not(:last-child) td {
            border-bottom: 1px solid var(--border);
        }

        .data-table tbody td {
            padding: 0.75rem 1rem;
        }

        .table-input, .table-textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid transparent;
            border-radius: 6px;
            font-size: 0.9375rem;
            font-family: 'Inter', sans-serif;
        }

        .table-input:focus {
            outline: none;
            border-color: var(--brand);
            background: rgba(0, 176, 240, 0.05);
        }

        .table-textarea {
            resize: none;
            overflow: hidden;
            min-height: 2.5rem;
        }

        .table-input.col-antal {
            text-align: center;
            font-weight: 600;
            color: var(--brand);
        }

        .actions-container {
            margin-top: 1rem;
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.8125rem;
            cursor: pointer;
            text-transform: uppercase;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-add {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-clear {
            background: white;
            color: #ef4444;
            border: 1.5px solid #ef4444;
        }

        .btn-delete {
            background: transparent;
            color: #9ca3af;
            font-size: 1.125rem;
        }

        .card-footer {
            padding: 1.5rem 3rem;
            background: white;
            border-top: 2px solid var(--brand);
            text-align: center;
            font-size: 0.8125rem;
            color: var(--text-light);
            line-height: 1.6;
        }

        .card-footer p {
            margin: 0.25rem 0;
        }

        .main-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-brand {
            background: linear-gradient(135deg, var(--brand) 0%, #0090cc 100%);
            color: white;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.4s;
            z-index: 10000;
            border: 1px solid var(--border);
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Modal de seguridad */
        .security-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 1rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .security-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .security-modal-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .security-modal.show .security-modal-content {
            transform: scale(1);
        }

        .security-modal-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--brand);
        }

        .security-modal-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .security-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
        }

        .security-modal-body {
            color: var(--text-light);
            line-height: 1.7;
            font-size: 0.9375rem;
            margin-bottom: 1.5rem;
        }

        .security-modal-body p {
            margin-bottom: 1rem;
        }

        .security-modal-body strong {
            color: var(--text);
            font-weight: 600;
        }

        .security-modal-features {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .security-modal-features ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .security-modal-features li {
            padding: 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .security-modal-features li::before {
            content: '✓';
            color: #10b981;
            font-weight: 700;
            font-size: 1.125rem;
        }

        .security-modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        .btn-accept {
            background: linear-gradient(135deg, var(--brand) 0%, #0090cc 100%);
            color: white;
        }

        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            @page {
                size: A4;
                margin: 25mm 15mm;
            }

            body, html {
                background: white !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
            }

            body::before {
                display: none !important;
            }

            .security-badge,
            .main-actions,
            .actions-container,
            .btn-delete,
            .toast,
            .security-modal {
                display: none !important;
            }

            .app-container {
                max-width: 100% !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            .document-card {
                box-shadow: none !important;
                border-radius: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                backdrop-filter: none !important;
            }

            /* Header fijo en cada página */
            .card-header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                padding: 0 15mm !important;
                background: white !important;
                border-bottom: 2px solid #00B0F0 !important;
                height: 20mm;
                display: flex;
                align-items: center;
                justify-content: flex-end;
                z-index: 9999;
            }

            .logo {
                font-size: 16pt !important;
                color: #00B0F0 !important;
            }

            /* Footer fijo en cada página */
            .card-footer {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                padding: 5mm 15mm !important;
                border-top: 2px solid #00B0F0 !important;
                background: white !important;
                z-index: 9999;
            }

            .card-footer p {
                font-size: 8pt !important;
                color: #666 !important;
                margin: 1mm 0 !important;
            }

            /* Contenido con espacio para header y footer */
            .card-content {
                padding: 0 !important;
                margin-top: 25mm !important;
                margin-bottom: 20mm !important;
                background: white !important;
            }

            .main-title {
                font-size: 14pt !important;
                font-weight: 700 !important;
                margin-bottom: 8mm !important;
                color: #000 !important;
            }

            .form-grid {
                grid-template-columns: 35% 65% !important;
                gap: 8mm !important;
                margin-bottom: 8mm !important;
            }

            .form-group {
                margin-bottom: 4mm !important;
                page-break-inside: avoid !important;
            }

            .form-label {
                font-size: 8pt !important;
                font-weight: 700 !important;
                margin-bottom: 1mm !important;
                color: #000 !important;
                text-transform: uppercase !important;
            }

            .form-input,
            .form-textarea {
                border: none !important;
                padding: 0 !important;
                font-size: 10pt !important;
                color: #000 !important;
                background: white !important;
                box-shadow: none !important;
            }

            .form-textarea {
                min-height: auto !important;
                resize: none !important;
            }

            .data-table {
                border: 1px solid #ccc !important;
                margin-top: 6mm !important;
                background: white !important;
            }

            .data-table thead {
                display: table-header-group !important;
                background: #00B0F0 !important;
            }

            .data-table th {
                font-size: 9pt !important;
                padding: 3mm !important;
                color: white !important;
                background: #00B0F0 !important;
            }

            .data-table tbody tr {
                page-break-inside: avoid !important;
                background: white !important;
            }

            .data-table tbody td {
                padding: 2.5mm 3mm !important;
                font-size: 10pt !important;
                border-bottom: 1px solid #e5e7eb !important;
                color: #000 !important;
                background: white !important;
            }

            .table-input,
            .table-textarea {
                border: none !important;
                padding: 0 !important;
                font-size: 10pt !important;
                background: white !important;
                color: #000 !important;
            }

            input[type="date"]::-webkit-calendar-picker-indicator,
            input[type="number"]::-webkit-inner-spin-button {
                display: none !important;
            }
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="security-badge">🔒 Sikker og krypteret</div>

    <main class="app-container">
        <div class="document-card">
            <header class="card-header">
                <h1 class="logo">Felson Watersafe ApS</h1>
            </header>

            <div class="card-content">
                <h2 class="main-title">Følgeseddel</h2>

                <div class="form-grid">
                    <div>
                        <div class="form-group">
                            <label for="dato" class="form-label">Dato</label>
                            <input type="date" class="form-input" id="dato">
                        </div>
                        <div class="form-group">
                            <label for="ordre-nr" class="form-label">Ordre nr.</label>
                            <input type="text" class="form-input" id="ordre-nr" placeholder="Indtast ordrenummer">
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label for="levering" class="form-label">Levering</label>
                            <textarea class="form-textarea" id="levering" placeholder="Indtast leveringsadresse" style="min-height: 90px;"></textarea>
                        </div>
                    </div>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="col-antal">Antal</th>
                            <th>Beskrivelse</th>
                            <th style="width: 60px;"></th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>

                <div class="actions-container">
                    <button class="btn btn-add" id="btn-add">+ Tilføj Række</button>
                    <button class="btn btn-clear" id="btn-clear">Ryd Alt</button>
                </div>
            </div>

            <footer class="card-footer">
                <p>Felson Watersafe ApS / Gartnervej 4 / 6710 Esbjerg V</p>
                <p>CVR-nr. DK26813522 / Tlf. 70206676 / felson@felson.dk</p>
            </footer>
        </div>

        <div class="main-actions">
            <button class="btn btn-brand" id="btn-pdf">📄 Generer PDF</button>
            <button class="btn btn-primary" id="btn-print">🖨️ Udskriv</button>
        </div>
    </main>

    <div class="toast" id="toast"></div>

    <div class="security-modal" id="securityModal">
        <div class="security-modal-content">
            <div class="security-modal-header">
                <div class="security-modal-icon">🔒</div>
                <h3 class="security-modal-title">Sikkerhed og Databeskyttelse</h3>
            </div>
            <div class="security-modal-body">
                <p>
                    Velkommen til Felson Watersafe ApS følgeseddel system. Vi tager din datasikkerhed alvorligt og ønsker at informere dig om, hvordan dine oplysninger beskyttes.
                </p>
                
                <div class="security-modal-features">
                    <ul>
                        <li>AES-256 kryptering af alle gemte data</li>
                        <li>Lokal lagring uden eksterne servere</li>
                        <li>Automatisk krypteret backup</li>
                        <li>Ingen data deles med tredjeparter</li>
                        <li>GDPR-kompatibel databehandling</li>
                    </ul>
                </div>

                <p>
                    <strong>Hvordan fungerer det?</strong><br>
                    Alle dine følgesedler gemmes krypteret i din browsers lokale hukommelse ved hjælp af avanceret AES-256 kryptering. Dette sikrer, at kun du kan tilgå dine data. Ingen oplysninger sendes til eksterne servere eller deles med nogen.
                </p>

                <p>
                    <strong>Din databeskyttelse:</strong><br>
                    Vi følger GDPR (General Data Protection Regulation) retningslinjer. Du har fuld kontrol over dine data og kan til enhver tid slette dem ved at bruge "Ryd Alt" funktionen. Dine ordreoplysninger forbliver fortrolige og sikre.
                </p>

                <p style="font-size: 0.875rem; color: #9ca3af; margin-top: 1.5rem;">
                    Ved at fortsætte accepterer du vores sikkerhedspraksis og bekræfter, at du har læst denne information om databeskyttelse.
                </p>
            </div>
            <div class="security-modal-actions">
                <button class="btn btn-accept" id="acceptSecurityBtn">Forstået og Accepter</button>
            </div>
        </div>
    </div>

    <template id="table-row-template">
        <tr>
            <td><input type="number" class="table-input col-antal" min="0" placeholder="0"></td>
            <td><textarea class="table-input table-textarea" rows="1" placeholder="Beskrivelse af vare"></textarea></td>
            <td style="text-align: center;"><button class="btn btn-delete">×</button></td>
        </tr>
    </template>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        (function() {
            'use strict';

            const { jsPDF } = window.jspdf;
            const STORAGE_KEY = 'felson_encrypted_data';
            const ENCRYPTION_KEY = 'FelsonWatersafe2025SecureKey';
            const SECURITY_ACCEPTED_KEY = 'felson_security_accepted';
            
            const datoInput = document.getElementById('dato');
            const ordreNrInput = document.getElementById('ordre-nr');
            const leveringInput = document.getElementById('levering');
            const tableBody = document.getElementById('table-body');
            const addRowBtn = document.getElementById('btn-add');
            const clearBtn = document.getElementById('btn-clear');
            const printBtn = document.getElementById('btn-print');
            const pdfBtn = document.getElementById('btn-pdf');
            const rowTemplate = document.getElementById('table-row-template');
            const toast = document.getElementById('toast');
            const securityModal = document.getElementById('securityModal');
            const acceptSecurityBtn = document.getElementById('acceptSecurityBtn');
            
            let autoSaveTimeout;

            function checkSecurityAcceptance() {
                const accepted = localStorage.getItem(SECURITY_ACCEPTED_KEY);
                if (!accepted) {
                    setTimeout(() => {
                        securityModal.classList.add('show');
                    }, 500);
                }
            }

            acceptSecurityBtn.addEventListener('click', () => {
                localStorage.setItem(SECURITY_ACCEPTED_KEY, 'true');
                securityModal.classList.remove('show');
                showToast('Sikkerhedsindstillinger accepteret');
            });

            function encrypt(data) {
                return CryptoJS.AES.encrypt(JSON.stringify(data), ENCRYPTION_KEY).toString();
            }

            function decrypt(encrypted) {
                try {
                    const bytes = CryptoJS.AES.decrypt(encrypted, ENCRYPTION_KEY);
                    return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
                } catch (e) {
                    return null;
                }
            }

            function addRow(antal = '', beskrivelse = '') {
                const newRow = rowTemplate.content.cloneNode(true);
                const antalInput = newRow.querySelector('.col-antal');
                const beskrivelseTextarea = newRow.querySelector('.table-textarea');
                
                if (antal) antalInput.value = antal;
                if (beskrivelse) {
                    beskrivelseTextarea.value = beskrivelse;
                    setTimeout(() => autoResizeTextarea(beskrivelseTextarea), 0);
                }
                
                tableBody.appendChild(newRow);
                triggerAutoSave();
            }

            function autoResizeTextarea(textarea) {
                if (!textarea) return;
                textarea.style.height = 'auto';
                textarea.style.height = Math.max(40, textarea.scrollHeight) + 'px';
            }

            function showToast(message) {
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            }

            function generatePDF() {
                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 20;
                const usableHeight = pageHeight - 60;
                
                let currentY = margin;
                let pageNumber = 1;

                function drawHeader() {
                    doc.setFillColor(0, 176, 240);
                    doc.rect(0, 0, pageWidth, 2, 'F');
                    doc.setFontSize(16);
                    doc.setTextColor(0, 176, 240);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Felson Watersafe ApS', pageWidth - margin, 15, { align: 'right' });
                }

                function drawFooter() {
                    doc.setFillColor(0, 176, 240);
                    doc.rect(0, pageHeight - 22, pageWidth, 2, 'F');
                    doc.setFontSize(8);
                    doc.setTextColor(100);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Felson Watersafe ApS / Gartnervej 4 / 6710 Esbjerg V', pageWidth / 2, pageHeight - 15, { align: 'center' });
                    doc.text('CVR-nr. DK26813522 / Tlf. 70206676 / felson@felson.dk', pageWidth / 2, pageHeight - 10, { align: 'center' });
                }

                function addNewPage() {
                    doc.addPage();
                    pageNumber++;
                    currentY = margin;
                    drawHeader();
                    currentY = 25;
                }

                drawHeader();
                currentY = 25;

                doc.setFontSize(14);
                doc.setTextColor(0);
                doc.setFont('helvetica', 'bold');
                doc.text('FØLGESEDDEL', pageWidth / 2, currentY, { align: 'center' });
                currentY += 12;

                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('DATO', margin, currentY);
                doc.text('LEVERING', pageWidth / 2, currentY);
                
                doc.setFont('helvetica', 'normal');
                const fecha = datoInput.value ? new Date(datoInput.value + 'T00:00:00').toLocaleDateString('da-DK') : '';
                doc.text(fecha, margin, currentY + 6);
                
                const leveringLines = doc.splitTextToSize(leveringInput.value || '', pageWidth / 2 - 25);
                doc.text(leveringLines, pageWidth / 2, currentY + 6);

                doc.setFont('helvetica', 'bold');
                doc.text('ORDRE NR.', margin, currentY + 10);
                doc.setFont('helvetica', 'normal');
                doc.text(ordreNrInput.value || '', margin, currentY + 16);
                
                currentY += Math.max(22, leveringLines.length * 5 + 12);

                doc.setFillColor(0, 176, 240);
                doc.rect(margin, currentY, pageWidth - 2 * margin, 8, 'F');
                doc.setTextColor(255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                doc.text('ANTAL', margin + 5, currentY + 5);
                doc.text('BESKRIVELSE', margin + 35, currentY + 5);
                currentY += 10;

                const rows = Array.from(tableBody.querySelectorAll('tr'));
                doc.setTextColor(0);
                doc.setFont('helvetica', 'normal');

                rows.forEach((row, index) => {
                    const antal = row.querySelector('.col-antal').value || '0';
                    const beskrivelse = row.querySelector('.table-textarea').value || '';
                    
                    const beskrivelseLines = doc.splitTextToSize(beskrivelse, pageWidth - margin - 45);
                    const rowHeight = Math.max(6, beskrivelseLines.length * 5);

                    if (currentY + rowHeight > usableHeight) {
                        drawFooter();
                        addNewPage();
                        
                        doc.setFillColor(0, 176, 240);
                        doc.rect(margin, currentY, pageWidth - 2 * margin, 8, 'F');
                        doc.setTextColor(255);
                        doc.setFont('helvetica', 'bold');
                        doc.text('ANTAL', margin + 5, currentY + 5);
                        doc.text('BESKRIVELSE', margin + 35, currentY + 5);
                        currentY += 10;
                        doc.setTextColor(0);
                        doc.setFont('helvetica', 'normal');
                    }

                    doc.setTextColor(0, 176, 240);
                    doc.setFont('helvetica', 'bold');
                    doc.text(antal, margin + 15, currentY + 4, { align: 'center' });
                    doc.setTextColor(0);
                    doc.setFont('helvetica', 'normal');
                    doc.text(beskrivelseLines, margin + 35, currentY + 4);
                    
                    doc.setDrawColor(200);
                    doc.line(margin, currentY + rowHeight, pageWidth - margin, currentY + rowHeight);
                    
                    currentY += rowHeight + 1;
                });

                drawFooter();

                doc.save(`folgeseddel_${ordreNrInput.value || 'dokument'}.pdf`);
                showToast('PDF genereret successfully!');
            }

            function saveData() {
                const data = {
                    dato: datoInput.value,
                    ordreNr: ordreNrInput.value,
                    levering: leveringInput.value,
                    rows: Array.from(tableBody.querySelectorAll('tr')).map(row => ({
                        antal: row.querySelector('.col-antal').value,
                        beskrivelse: row.querySelector('.table-textarea').value
                    }))
                };
                
                try {
                    const encrypted = encrypt(data);
                    localStorage.setItem(STORAGE_KEY, encrypted);
                } catch (e) {}
            }

            function loadData() {
                try {
                    const encrypted = localStorage.getItem(STORAGE_KEY);
                    if (!encrypted) return false;
                    
                    const data = decrypt(encrypted);
                    if (!data) return false;
                    
                    datoInput.value = data.dato || '';
                    ordreNrInput.value = data.ordreNr || '';
                    leveringInput.value = data.levering || '';
                    
                    tableBody.innerHTML = '';
                    if (data.rows?.length) {
                        data.rows.forEach(row => addRow(row.antal, row.beskrivelse));
                    } else {
                        addRow();
                    }
                    return true;
                } catch (e) {
                    return false;
                }
            }

            function clearAllData() {
                if (!confirm('Er du sikker på at du vil rydde alle data?')) return;
                datoInput.value = '';
                ordreNrInput.value = '';
                leveringInput.value = '';
                tableBody.innerHTML = '';
                addRow();
                localStorage.removeItem(STORAGE_KEY);
                showToast('Alle data er ryddet');
            }

            function triggerAutoSave() {
                clearTimeout(autoSaveTimeout);
                autoSaveTimeout = setTimeout(saveData, 1000);
            }

            function setupEventListeners() {
                addRowBtn.addEventListener('click', () => addRow());
                clearBtn.addEventListener('click', clearAllData);
                pdfBtn.addEventListener('click', generatePDF);
                printBtn.addEventListener('click', () => {
                    showToast('Preparando para imprimir...');
                    setTimeout(() => window.print(), 500);
                });

                [datoInput, ordreNrInput, leveringInput].forEach(input => {
                    input.addEventListener('input', triggerAutoSave);
                });

                tableBody.addEventListener('click', (e) => {
                    if (e.target.classList.contains('btn-delete')) {
                        if (tableBody.rows.length > 1) {
                            e.target.closest('tr').remove();
                            triggerAutoSave();
                        } else {
                            showToast('Der skal være mindst én række');
                        }
                    }
                });

                tableBody.addEventListener('input', (e) => {
                    if (e.target.classList.contains('table-textarea')) {
                        autoResizeTextarea(e.target);
                    }
                    triggerAutoSave();
                });
            }

            function init() {
                checkSecurityAcceptance();
                
                const hasData = loadData();
                if (!datoInput.value) datoInput.valueAsDate = new Date();
                if (tableBody.rows.length === 0) addRow();
                setupEventListeners();
                if (hasData) showToast('Data indlæst sikkert');
            }

            init();
        })();
    </script>
</body>
</html>
