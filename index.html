<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- CSP fuerte: anti-XSS, anti-clickjacking, nada de inline JS -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self' 'nonce-abc123';
          style-src 'self' 'unsafe-inline';
          img-src 'self' data:;
          object-src 'none';
          base-uri 'none';
          frame-ancestors 'none';
          form-action 'self';
          upgrade-insecure-requests">

  <title>Følgeseddel – Felson Watersafe ApS</title>

  <style>
    /* ===== Base / theme ===== */
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    :root{
      --ink:#111827; --muted:#667085; --bg-grad1:#667eea; --bg-grad2:#764ba2;
      --line:#e5e7eb; --line-strong:#c9d1dc; --accent:#5b21b6; --accent-2:#8b5cf6;
      --success:#10b981; --danger:#ef4444;
    }
    body{
      font-family:"Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:linear-gradient(135deg, var(--bg-grad1) 0%, var(--bg-grad2) 100%);
      min-height:100vh; padding:24px; display:flex; align-items:center; justify-content:center;
      color:var(--ink);
    }
    .wrap{width:100%; max-width:980px}

    .doc{
      background:#fff; border-radius:16px; overflow:hidden;
      box-shadow:0 24px 60px rgba(0,0,0,.25);
      display:flex; flex-direction:column;
    }

    /* ===== Header ===== */
    .doc__header{
      background:linear-gradient(135deg, var(--bg-grad1) 0%, var(--bg-grad2) 100%);
      padding:28px 32px; display:flex; justify-content:flex-end; align-items:center;
      position:relative;
    }
    .doc__header::after{
      content:""; position:absolute; inset:auto 6% -20% auto; width:40%; height:160%;
      background:rgba(255,255,255,.08); transform:rotate(28deg);
    }
    .brand{color:#fff; font-weight:900; letter-spacing:.6px}

    /* ===== Content ===== */
    .doc__content{padding:26px 32px 18px}
    h1.title{
      text-align:center; text-transform:uppercase; letter-spacing:1.6px;
      margin-bottom:22px; font-size:28px; font-weight:900; color:#2d3748;
    }

    /* Details: Dato (left) | Levering (right) | Ordre nr. full width */
    .details{
      display:grid; grid-template-columns:1fr 1fr; gap:16px 24px; align-items:start; margin-bottom:16px;
    }
    .details .full{ grid-column:1 / -1 }
    .label{display:block; font-weight:700; color:#3b4452; margin-bottom:6px; font-size:.95rem}
    .input, .textarea{
      width:100%; padding:12px; border:2px solid var(--line); border-radius:10px;
      background:#f7fafc; font:inherit; font-size:15px; transition:border-color .18s, box-shadow .18s, background .18s;
    }
    .input:focus, .textarea:focus{ outline:none; border-color:var(--accent-2); background:#fff; box-shadow:0 0 0 4px rgba(139,92,246,.12) }
    .textarea{ min-height:92px; resize:vertical }

    /* ===== Table ===== */
    .tablebox{ margin-top:8px }
    table.items{
      width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed;
      border:2px solid var(--line); border-radius:12px; overflow:hidden;
    }
    .items thead{ background:linear-gradient(135deg, var(--bg-grad1) 0%, var(--bg-grad2) 100%) }
    .items th{
      padding:12px 14px; text-align:left; color:#fff; text-transform:uppercase; font-size:.85rem; letter-spacing:.5px;
      border-right:2px solid rgba(255,255,255,.35);
    }
    .items th:last-child{ border-right:none }
    .items th.qty{ width:20% }
    .items tbody tr{ background:#fff }
    .items td{ padding:10px 12px; vertical-align:top; border-top:1px solid var(--line) }
    .items td.qty{ border-right:1px solid var(--line-strong); text-align:center }
    .cell{
      width:100%; padding:8px 10px; border:1px solid #cbd5e0; border-radius:8px; background:#fff;
      font:inherit; font-size:14px; transition:border-color .18s, box-shadow .18s;
    }
    .cell:focus{ outline:none; border-color:var(--accent-2); box-shadow:0 0 0 3px rgba(139,92,246,.12) }
    .cell.area{ min-height:42px; line-height:1.4; resize:vertical; overflow:hidden }

    .controls{ width:56px; text-align:center }
    .btn-del{
      background:#fff; border:2px solid var(--danger); color:var(--danger);
      width:34px; height:34px; border-radius:8px; cursor:pointer; font-size:18px; line-height:0;
      display:inline-grid; place-items:center; transition:transform .15s, background .15s, color .15s;
    }
    .btn-del:hover{ background:var(--danger); color:#fff; transform:scale(1.06) rotate(90deg) }

    .btn-add{
      margin-top:10px; display:inline-block; background:linear-gradient(135deg, var(--success) 0%, #059669 100%);
      color:#fff; border:none; padding:12px 18px; border-radius:10px; font-weight:900; cursor:pointer;
      box-shadow:0 4px 12px rgba(16,185,129,.28); letter-spacing:.2px; transition:.18s;
    }
    .btn-add:hover{ transform:translateY(-2px); box-shadow:0 8px 18px rgba(16,185,129,.35) }

    /* ===== Actions ===== */
    .actions{ display:flex; gap:12px; justify-content:center; padding:16px 32px 22px }
    .btn{
      padding:14px 28px; border-radius:12px; cursor:pointer; font-weight:900; font-size:15px;
      text-transform:uppercase; letter-spacing:.5px; transition:transform .18s, box-shadow .18s, background .18s, color .18s, border-color .18s;
      border:2px solid transparent; min-width:210px;
    }
    .btn.primary{ background:linear-gradient(135deg, var(--bg-grad1) 0%, var(--bg-grad2) 100%); color:#fff; box-shadow:0 6px 16px rgba(102,126,234,.35) }
    .btn.primary:hover{ transform:translateY(-2px) }
    .btn.secondary{ background:#fff; color:var(--bg-grad1); border-color:var(--bg-grad1) }
    .btn.secondary:hover{ background:var(--bg-grad1); color:#fff; transform:translateY(-2px) }

    .actions__meta{ text-align:center; font-size:12px; color:var(--muted); margin-top:-8px }

    /* ===== Footer ===== */
    .doc__footer{
      padding:16px 24px; background:#f7fafc; border-top:2px solid var(--line);
      color:#6b7280; text-align:center; font-size:.95rem; line-height:1.5;
    }

    /* ===== Responsive ===== */
    @media (max-width:768px){
      body{ padding:14px }
      .doc__content{ padding:22px 16px 12px }
      .details{ grid-template-columns:1fr }
      .actions{ flex-direction:column }
      .btn{ width:100% }
    }

    /* ===== Print (BN, clásico limpio) ===== */
    @media print{
      @page{ size:A4; margin:2cm }
      body{ background:#fff; padding:0; color:#000; font-family:'Times New Roman', Times, serif }
      .doc{ box-shadow:none; border-radius:0 }
      .doc__header{ background:#fff !important; border-bottom:2px solid #000 !important; padding:16px 24px }
      .brand{ color:#000 !important; font-weight:700 }
      .actions, .btn-add, .btn-del{ display:none !important }

      h1.title{
        color:#000; font-weight:normal; font-size:1.35rem; text-decoration:underline;
        margin:18px 0 14px;
      }

      table.items{ border:1px solid #000 !important }
      .items thead{ background:#fff !important; border-bottom:2px solid #000 !important }
      .items th{ color:#000 !important; border-right:1px solid #000 !important }
      .items th:last-child{ border-right:none !important }
      .items td{ border-top:1px solid #000 !important }
      .items td.qty{ border-right:1px solid #000 !important }

      /* inputs/áreas como texto liso */
      input.cell, textarea.cell, .input, .textarea{
        border:none !important; background:transparent !important; padding:0 !important; box-shadow:none !important;
      }

      /* oculta col. de controles en impresión */
      .items th.controls, .items td.controls{ display:none !important }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <article class="doc" role="document" aria-label="Følgeseddel">
      <header class="doc__header">
        <h2 class="brand">FELSON WATERSAFE ApS</h2>
      </header>

      <section class="doc__content">
        <h1 class="title">FØLGESEDDEL</h1>

        <!-- Dato (izq) | Levering (der) | Ordre nr. abajo full -->
        <section class="details" aria-label="Detaljer">
          <div>
            <label class="label" for="dato">Dato</label>
            <input id="dato" type="date" class="input" autocomplete="off" />
          </div>
          <div>
            <label class="label" for="levering">Levering</label>
            <textarea id="levering" class="textarea" placeholder="Leveringsadresse"></textarea>
          </div>
          <div class="full">
            <label class="label" for="ordre">Ordre nr.</label>
            <input id="ordre" type="text" class="input" placeholder="Indtast ordrenummer" autocomplete="off" inputmode="numeric"/>
          </div>
        </section>

        <!-- Table -->
        <div class="tablebox">
          <table class="items" aria-label="Varelinjer">
            <thead>
              <tr>
                <th class="qty">Antal</th>
                <th>Beskrivelse</th>
                <th class="controls" aria-hidden="true"></th>
              </tr>
            </thead>
            <tbody id="rows">
              <tr>
                <td class="qty">
                  <input class="cell" type="number" min="0" step="1" inputmode="numeric" pattern="[0-9]*" placeholder="0" />
                </td>
                <td>
                  <textarea class="cell area" rows="1" placeholder="Beskrivelse af vare"></textarea>
                </td>
                <td class="controls">
                  <button class="btn-del" type="button" title="Slet række" aria-label="Slet række">×</button>
                </td>
              </tr>
            </tbody>
          </table>
          <button id="add" class="btn-add" type="button">Tilføj række</button>
        </div>
      </section>

      <section class="actions" aria-label="Handling">
        <button id="save" class="btn secondary" type="button">Gem som PDF</button>
        <button id="print" class="btn primary" type="button">Udskriv</button>
      </section>
      <p class="actions__meta">Tip: Ctrl/⌘+Enter = Tilføj række · Ctrl/⌘+S = Gem som PDF</p>

      <footer class="doc__footer">
        <p>Felson Watersafe ApS • Gartnervej 4 • 6710 Esbjerg V</p>
        <p>CVR-nr. DK26813522 • Tlf. 70206676 • felson@felson.dk</p>
      </footer>
    </article>
  </main>

  <!-- JS seguro con CSP nonce -->
  <script nonce="abc123">
    (function(){
      'use strict';

      /* ========= Helpers ========= */
      const $ = (sel, ctx=document) => ctx.querySelector(sel);
      const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));

      // Prefill date
      const dateEl = $('#dato');
      if (dateEl) {
        const t = new Date();
        const yyyy = t.getFullYear();
        const mm = String(t.getMonth()+1).padStart(2,'0');
        const dd = String(t.getDate()).padStart(2,'0');
        dateEl.value = `${yyyy}-${mm}-${dd}`;
      }

      // Autosize textareas (incluye Levering + descripciones)
      const autoGrow = (el) => { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; };
      document.addEventListener('input', (e) => {
        const t = e.target;
        if (t && (t.classList.contains('area') || t.id === 'levering')) autoGrow(t);
      });
      $$('.area, #levering').forEach(autoGrow);

      // Crear fila de forma segura (sin innerHTML con datos del usuario)
      const rows = $('#rows');
      const createRow = () => {
        const tr = document.createElement('tr');

        const tdQty = document.createElement('td');
        tdQty.className = 'qty';
        const qty = document.createElement('input');
        qty.className = 'cell';
        qty.type = 'number'; qty.min = '0'; qty.step = '1';
        qty.setAttribute('inputmode','numeric'); qty.setAttribute('pattern','[0-9]*');
        qty.placeholder = '0';
        tdQty.appendChild(qty);

        const tdDesc = document.createElement('td');
        const desc = document.createElement('textarea');
        desc.className = 'cell area'; desc.rows = 1; desc.placeholder = 'Beskrivelse af vare';
        tdDesc.appendChild(desc);

        const tdCtl = document.createElement('td');
        tdCtl.className = 'controls';
        const del = document.createElement('button');
        del.className = 'btn-del'; del.type = 'button';
        del.title = 'Slet række'; del.setAttribute('aria-label','Slet række');
        del.textContent = '×';
        tdCtl.appendChild(del);

        tr.appendChild(tdQty); tr.appendChild(tdDesc); tr.appendChild(tdCtl);
        return tr;
      };

      // Añadir fila
      $('#add').addEventListener('click', () => {
        const tr = createRow();
        rows.appendChild(tr);
      });

      // Borrar fila (delegado)
      rows.addEventListener('click', (e) => {
        const btn = e.target.closest('.btn-del');
        if (!btn) return;
        const all = rows.querySelectorAll('tr');
        if (all.length > 1) btn.closest('tr').remove();
        else alert('Der skal være mindst én række');
      });

      // Atajos: Ctrl/⌘+Enter = Add row, Ctrl/⌘+S = print dialog (save as PDF)
      document.addEventListener('keydown', (e) => {
        const mod = e.ctrlKey || e.metaKey;
        if (mod && e.key === 'Enter') { e.preventDefault(); $('#add').click(); }
        if (mod && (e.key.toLowerCase() === 's')) { e.preventDefault(); window.print(); }
      });

      // Botones → print dialog (el CSS ya limpia la vista)
      $('#save').addEventListener('click', () => window.print());
      $('#print').addEventListener('click', () => window.print());

      /* ========= Autosave seguro (localStorage) ========= */
      const STORAGE_KEY = 'felson_foelgeseddel_v1';
      function serialize(){
        return {
          dato: $('#dato')?.value || '',
          ordre: $('#ordre')?.value || '',
          levering: $('#levering')?.value || '',
          rows: $$('#rows tr').map(tr => ({
            antal: tr.querySelector('.qty .cell')?.value || '',
            beskrivelse: tr.querySelector('td textarea')?.value || ''
          }))
        };
      }
      function hydrate(state){
        if (!state) return;
        $('#dato').value = state.dato || '';
        $('#ordre').value = state.ordre || '';
        $('#levering').value = state.levering || '';
        rows.innerHTML = ''; // seguro: sólo nosotros controlamos el template
        (state.rows && state.rows.length ? state.rows : [{antal:'',beskrivelse:''}]).forEach(r => {
          const tr = createRow();
          tr.querySelector('.qty .cell').value = r.antal || '';
          const area = tr.querySelector('td textarea');
          area.value = r.beskrivelse || '';
          autoGrow(area);
          rows.appendChild(tr);
        });
      }
      // Cargar al entrar
      try { const saved = localStorage.getItem(STORAGE_KEY); if (saved) hydrate(JSON.parse(saved)); } catch {}
      // Guardar cada cambio (con debounce simple)
      let tSave;
      document.addEventListener('input', () => {
        clearTimeout(tSave);
        tSave = setTimeout(() => {
          try { localStorage.setItem(STORAGE_KEY, JSON.stringify(serialize())); } catch {}
        }, 250);
      });

    })();
  </script>
</body>
</html>
